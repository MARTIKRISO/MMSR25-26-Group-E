{% extends "partials/base.html" %}
{% block content %}

<div class="min-h-screen bg-purple-50 px-8 py-6">

    <!-- Title -->
    <h1 class="text-4xl font-semibold text-gray-800 mb-6">
        <a href="/">Multimedia Search and Retrieval: Practical Project - Music Search System</a>
    </h1>

    <!-- Search Panel -->
    <form id="searchForm" method="get" action="" class="flex items-end gap-4 bg-purple-100 p-6 rounded-xl shadow-sm">
        <!-- Search Input with Autocomplete -->
        <div class="flex-1 relative" id="autocompleteWrapper">
            <div class="flex items-center bg-white rounded-full border-2 border-purple-200 px-4 py-2">
                <input type="text" id="searchInput" name="query" class="flex-1 outline-none bg-transparent"
                    placeholder="Search for a song or artist..." value="{{ query }}" autocomplete="off">
                <button type="submit" class="text-gray-600 text-xl">üîç</button>
            </div>

            <!-- Autocomplete Dropdown -->
            <div id="autocompleteDropdown"
                class="absolute w-full mt-2 bg-white rounded-xl shadow-lg border border-purple-200 max-h-96 overflow-y-auto hidden z-50">
                <!-- Results will be inserted here -->
            </div>
        </div>

        <!-- Track Count -->
        <div class="flex flex-col w-28">
            <label class="text-sm text-gray-600"># of Tracks</label>
            <input type="number" name="track_count" class="h-12 border border-gray-300 rounded-md px-2 py-1"
                value="{{ track_count }}" min="1">
        </div>

        <!-- Settings Menu -->
        <div class="relative">
            <button id="settingsBtn" type="button"
                class="h-12 bg-purple-500 text-white p-3 rounded-lg shadow hover:bg-purple-600"
                onclick="toggleSettings()">
                ‚öô
            </button>

            <div id="settingsMenu"
                class="absolute right-0 mt-2 w-48 bg-white border border-gray-300 rounded-xl shadow hidden z-20">

                <button type="button" onclick="openDialog('sort')"
                    class="flex items-center justify-between w-full px-4 py-3 text-gray-700 hover:bg-gray-100">
                    <span>Sort by</span><span>‚Ä∫</span>
                </button>

                <button type="button" onclick="openDialog('filter')"
                    class="flex items-center justify-between w-full px-4 py-3 text-gray-700 hover:bg-gray-100">
                    <span>Filter</span><span>‚Ä∫</span>
                </button>

                <button type="button" onclick="openDialog('algorithm')"
                    class="flex items-center justify-between w-full px-4 py-3 text-gray-700 hover:bg-gray-100">
                    <span>Algorithms</span><span>‚Ä∫</span>
                </button>
                <button type="button" onclick="openDialog('normalization')"
                    class="flex items-center justify-between w-full px-4 py-3 text-gray-700 hover:bg-gray-100">
                    <span>Normalization</span><span>‚Ä∫</span>
                </button>

            </div>
        </div>

        <!-- Placeholders for sort_by, filter_by, algorithm and modalities -->
        <input type="hidden" name="sort_by" id="sortByInput" value="{{ sort_by }}">
        <input type="hidden" name="filter_by" id="filterByInput" value="{{ filter_by }}">
        <input type="hidden" name="algorithm" id="algorithmInput" value="{{ algorithm }}">
        <input type="hidden" name="modalities" id="modalitiesInput" value="{{ modalities }}">
        <input type="hidden" name="normalization" id="normalizationInput" value="{{ normalization }}">
    </form>

    <!-- Selected Song Display -->
    <div id="selectedSongSection" class="mt-6 hidden">
        <h2 class="text-xl font-semibold text-gray-800 mb-3">Selected Song</h2>
        <div id="selectedSongCard"
            class="flex items-center bg-green-50 border-2 border-green-300 rounded-xl p-4 shadow-md">
            <!-- Content will be inserted dynamically -->
        </div>
    </div>

    <!-- Results -->

    <!-- Main Content Grid -->
    <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6 h-[600px]">

        <!-- Left Column: Results -->
        <div class="overflow-y-auto space-y-4 pr-2 custom-scrollbar">
            {% for track in results %}
            <div class="flex items-center bg-purple-100 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">

                {% if track.url %}
                <a href="{{ track.url | youtube_watch_url }}" target="_blank"
                    class="w-32 aspect-video bg-gray-700 rounded-md overflow-hidden flex-shrink-0 relative group">
                    <img src="{{ track.url | youtube_thumbnail }}" alt="{{ track.song }}"
                        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">
                    <div
                        class="absolute inset-0 bg-black/20 group-hover:bg-black/40 transition-colors flex items-center justify-center">
                        <div
                            class="w-8 h-8 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 fill-current" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </div>
                    </div>
                </a>
                {% endif %}

                <!-- Info -->
                <div class="ml-4 flex-1 min-w-0">
                    <div class="text-xl font-semibold text-gray-800 truncate" title="{{ track.song }}">{{ track.song }}
                    </div>
                    <div class="text-base text-gray-600 truncate">
                        {{ track.artist }}{% if track.album %} - {{ track.album }}{% endif %}
                    </div>
                    <div class="text-sm text-gray-500 mt-1">{{ track.genre }}</div>
                </div>

                <!-- Score -->
                <div class="ml-2 text-right">
                    {% if track.score %}
                    <div class="text-sm font-bold text-purple-600">
                        {{ track.score | round(3) }}
                    </div>
                    <div class="text-xs text-gray-500">score</div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="text-center text-gray-500 py-10">
                Search for a song to get started!
            </div>
            {% endfor %}
        </div>

        <!-- Right Column: Metrics & Config -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 overflow-y-auto">

            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Metrics</h2>

            <!-- Metrics Grid -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                {% for key, value in metrics.items() %}
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <div class="text-3xl font-bold text-purple-600">{{ value }}</div>
                    <div class="text-sm text-gray-600 uppercase tracking-wide mt-1">{{ key }}</div>
                </div>
                {% endfor %}
            </div>

            <!-- Current Configuration -->
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Current Configuration</h3>
            <div class="space-y-3">

                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-600">Algorithm</span>
                    <span class="font-medium text-purple-700 bg-purple-100 px-3 py-1 rounded-full text-sm">
                        {{ algorithm_label }}
                    </span>
                </div>

                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-600">Normalization</span>
                    <span class="font-medium text-blue-700 bg-blue-100 px-3 py-1 rounded-full text-sm">
                        {{ normalization_label }}
                    </span>
                </div>

                <div class="flex justify-between items-start p-3 bg-gray-50 rounded-lg">
                    <span class="text-gray-600">Modalities</span>
                    <div id="modalitiesDisplay" class="flex flex-wrap gap-2 justify-end">
                        {% if modalities %}
                        {% for modality in modalities.split() %}
                        <span class="font-medium text-green-700 bg-green-100 px-3 py-1 rounded-full text-sm">
                            {{ modality | title }}
                        </span>
                        {% endfor %}
                        {% else %}
                        <span class="text-gray-400 text-sm">None</span>
                        {% endif %}
                    </div>
                </div>

            </div>

        </div>

    </div>

    <!-- Modal Overlay -->
    <div id="dialogOverlay" class="fixed inset-0 bg-black bg-opacity-40 hidden z-30 flex items-center justify-center">

        <!-- Modal Box -->
        <div class="bg-white rounded-xl shadow-xl p-6 w-96">

            <h2 id="dialogTitle" class="text-xl font-semibold text-gray-800 mb-4"></h2>

            <div id="dialogOptions" class="space-y-2">
                <!-- List items injected dynamically -->
            </div>

            <div class="mt-6 flex justify-end gap-2">
                <button type="button" onclick="closeDialog()"
                    class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">
                    Cancel
                </button>

                <button id="dialogSubmitBtn" type="button" onclick="submitModalities()"
                    class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:opacity-50 disabled:cursor-not-allowed hidden"
                    disabled>
                    Submit
                </button>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script>
        // ==========================================================================
        // AUTOCOMPLETE MODULE
        // ==========================================================================

        // --- State Variables ---
        let autocompleteTimeout = null;
        let autocompleteResults = [];
        let selectedSong = null;
        let currentFocusIndex = -1;

        // --- DOM Elements ---
        const searchInput = document.getElementById('searchInput');
        const autocompleteDropdown = document.getElementById('autocompleteDropdown');
        const autocompleteWrapper = document.getElementById('autocompleteWrapper');
        const selectedSongSection = document.getElementById('selectedSongSection');
        const selectedSongCard = document.getElementById('selectedSongCard');

        // --- Initialization ---
        (function init() {
            restoreSelectedSong();
        })();

        function restoreSelectedSong() {
            const savedSong = sessionStorage.getItem('selectedSong');
            if (savedSong) {
                try {
                    selectSong(JSON.parse(savedSong));
                } catch (e) {
                    sessionStorage.removeItem('selectedSong');
                }
            }
        }

        // --- Event Listeners ---
        searchInput.addEventListener('input', handleSearchInput);
        searchInput.addEventListener('keydown', handleKeyboardNavigation);
        document.addEventListener('click', handleOutsideClick);

        function handleSearchInput(e) {
            const query = e.target.value.trim();
            clearTimeout(autocompleteTimeout);

            if (query.length < 2) {
                autocompleteDropdown.classList.add('hidden');
                return;
            }

            autocompleteTimeout = setTimeout(() => {
                fetchAutocompleteSuggestions(query);
            }, 300);
        }

        function handleKeyboardNavigation(e) {
            const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');

            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    currentFocusIndex = Math.min(currentFocusIndex + 1, items.length - 1);
                    updateFocus(items);
                    break;

                case 'ArrowUp':
                    e.preventDefault();
                    currentFocusIndex = Math.max(currentFocusIndex - 1, -1);
                    updateFocus(items);
                    break;

                case 'Enter':
                    if (currentFocusIndex >= 0 && autocompleteResults[currentFocusIndex]) {
                        e.preventDefault();
                        selectSong(autocompleteResults[currentFocusIndex]);
                    }
                    break;

                case 'Escape':
                    autocompleteDropdown.classList.add('hidden');
                    currentFocusIndex = -1;
                    break;
            }
        }

        function handleOutsideClick(e) {
            if (!autocompleteWrapper.contains(e.target)) {
                autocompleteDropdown.classList.add('hidden');
                currentFocusIndex = -1;
            }
        }

        // --- API Functions ---
        async function fetchAutocompleteSuggestions(query) {
            try {
                const response = await fetch(`/api/autocomplete?q=${encodeURIComponent(query)}`);
                const results = await response.json();
                displayAutocompleteSuggestions(results);
            } catch (error) {
                console.error('Autocomplete error:', error);
                autocompleteDropdown.classList.add('hidden');
            }
        }

        // --- Display Functions ---
        function displayAutocompleteSuggestions(results) {
            if (results.length === 0) {
                autocompleteDropdown.classList.add('hidden');
                return;
            }

            autocompleteResults = results;
            autocompleteDropdown.innerHTML = results.map((song, index) => `
            <div class="autocomplete-item flex items-center p-3 hover:bg-purple-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                 data-index="${index}">
                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-gray-800 truncate">${escapeHtml(song.song)}</div>
                    <div class="text-sm text-gray-600 truncate">${escapeHtml(song.artist)}</div>
                </div>
                <div class="ml-2 text-xs text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>
        `).join('');

            autocompleteDropdown.classList.remove('hidden');
            currentFocusIndex = -1;
            bindAutocompleteClickHandlers();
        }

        function bindAutocompleteClickHandlers() {
            document.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const index = parseInt(this.getAttribute('data-index'));
                    if (autocompleteResults[index]) {
                        selectSong(autocompleteResults[index]);
                    }
                });
            });
        }

        function updateFocus(items) {
            items.forEach((item, index) => {
                item.classList.toggle('bg-purple-50', index === currentFocusIndex);
                if (index === currentFocusIndex) {
                    item.scrollIntoView({ block: 'nearest' });
                }
            });
        }

        // --- Song Selection ---
        function selectSong(song) {
            selectedSong = song;

            const videoId = getYtVideoId(song.url);
            const thumbnailUrl = videoId ? `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` : '';
            const parsedGenre = parseGenre(song.genre);

            selectedSongCard.innerHTML = buildSelectedSongHTML(song, thumbnailUrl, parsedGenre);
            selectedSongSection.classList.remove('hidden');
            searchInput.value = song.song;
            autocompleteDropdown.classList.add('hidden');
            sessionStorage.setItem('selectedSong', JSON.stringify(song));
        }

        function buildSelectedSongHTML(song, thumbnailUrl, genre) {
            const thumbnailHTML = song.url ? `
            <a href="${escapeHtml(song.url)}" target="_blank"
               class="w-32 aspect-video bg-gray-700 rounded-md overflow-hidden flex-shrink-0 relative group">
                <img src="${thumbnailUrl}" alt="${escapeHtml(song.song)}"
                     class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">
                <div class="absolute inset-0 bg-black/20 group-hover:bg-black/40 transition-colors flex items-center justify-center">
                    <div class="w-8 h-8 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-white opacity-0 group-hover:opacity-100 transition-opacity">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 fill-current" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z" />
                        </svg>
                    </div>
                </div>
            </a>
        ` : '';

            return `
            ${thumbnailHTML}
            <div class="ml-4 flex-1 min-w-0">
                <div class="text-xl font-semibold text-gray-800 truncate">${escapeHtml(song.song)}</div>
                <div class="text-base text-gray-600 truncate">
                    ${escapeHtml(song.artist)}${song.album ? ' - ' + escapeHtml(song.album) : ''}
                </div>
                <div class="text-sm text-gray-500 mt-1">${escapeHtml(genre)}</div>
            </div>
            <button onclick="clearSelectedSong()" class="ml-2 text-red-500 hover:text-red-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        `;
        }

        function clearSelectedSong() {
            selectedSong = null;
            selectedSongSection.classList.add('hidden');
            searchInput.value = '';
            searchInput.focus();
            sessionStorage.removeItem('selectedSong');
        }

        // --- Utility Functions ---
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function getYtVideoId(url) {
            if (!url) return '';
            if (url.includes('watch?v=')) return url.split('watch?v=')[1].split('&')[0];
            if (url.includes('youtu.be/')) return url.split('youtu.be/')[1].split('?')[0];
            if (url.includes('embed/')) return url.split('embed/')[1].split('?')[0];
            return '';
        }

        function parseGenre(genre) {
            if (!genre) return '';
            if (genre.startsWith('[') && genre.endsWith(']')) {
                try {
                    return genre.slice(1, -1)
                        .split(',')
                        .map(item => item.trim().replace(/^['"]|['"]$/g, ''))
                        .filter(item => item.length > 0)
                        .join(', ');
                } catch (e) {
                    return genre;
                }
            }
            return genre;
        }

        // ==========================================================================
        // SETTINGS DIALOG MODULE
        // ==========================================================================


        const dialogConfig = {
            sort: {
                title: "Sort by",
                inputId: "sortByInput",
                options: [
                    { value: "default", label: "Score" },
                    { value: "song", label: "Title" },
                    { value: "artist", label: "Artist" },
                ]
            },
            filter: {
                title: "Filter",
                inputId: "filterByInput",
                options: [
                    { value: "default", label: "No Filter" },
                    { value: "artist", label: "Artist" },
                    { value: "genre", label: "Genre" },
                ]
            },
            algorithm: {
                title: "Algorithm",
                inputId: "algorithmInput",
                options: [
                    { value: "random", label: "Random Baseline" },
                    { value: "unimodal", label: "Unimodal" },
                    { value: "early_fusion", label: "Early Fusion" },
                    { value: "late_fusion", label: "Late Fusion" },
                    { value: "rrf", label: "Late Fusion (RRF)" },
                    { value: "nn", label: "Neural Network" }
                ]
            },
            modalities: {
                options: [
                    { value: "lyrics", label: "Lyrics" },
                    { value: "audio", label: "Audio" },
                    { value: "video", label: "Video" }
                ]
            },
            normalization: {
                title: "Normalization",
                inputId: "normalizationInput",
                options: [
                    { value: "raw", label: "Raw (no normalization)" },
                    { value: "max_abs", label: "Max-Abs" },
                    { value: "min_max", label: "Min-Max" },
                    { value: "standard", label: "Standard" },
                    { value: "robust", label: "Robust" }
                ]
            },
        };

        function openDialog(type) {
            document.body.style.overflow = "hidden";

            // Hide submit by default (only modalities dialog uses it)
            const submitBtn = document.getElementById("dialogSubmitBtn");
            if (submitBtn) {
                submitBtn.classList.add("hidden");
                submitBtn.disabled = true;
            }

            const cfg = dialogConfig[type];
            const inputElem = document.getElementById(cfg.inputId);

            let currentValue = "";
            if (inputElem.value.includes(" ")) {
                currentValue = cfg.options[0].value;
            } else {
                currentValue = inputElem.value;
            }

            document.getElementById("dialogTitle").textContent = cfg.title;

            const listHtml = cfg.options.map(opt => `
            <button type="button"
                class="option-btn w-full flex justify-between items-center px-4 py-2 border rounded-lg hover:bg-purple-50
                    ${currentValue === opt.value ? 'selected-option' : ''}"
                onclick="selectOption('${cfg.inputId}', '${opt.value}', this)"
                data-value="${opt.value}">

                <span>${opt.label}</span>

                ${currentValue === opt.value
                    ? '<span class="tickmark text-purple-600 font-bold">‚úì</span>'
                    : ''
                }
            </button>
        `).join("");

            document.getElementById("dialogOptions").innerHTML = listHtml;

            document.getElementById("dialogOverlay").classList.remove("hidden");
            document.getElementById("settingsMenu").classList.add("hidden");
        }

        function updateConfigurationDisplay(inputId, value) {
            let labelText = value;

            if (inputId === "algorithmInput") {
                const algorithmOption = dialogConfig.algorithm.options.find(opt => opt.value === value);
                if (algorithmOption) labelText = algorithmOption.label;

                const algorithmDisplay = document.querySelector(
                    '.flex.justify-between.items-center.p-3.bg-gray-50.rounded-lg span.font-medium.text-purple-700'
                );
                if (algorithmDisplay) algorithmDisplay.textContent = labelText;

            } else if (inputId === "normalizationInput") {
                const normalizationOption = dialogConfig.normalization.options.find(opt => opt.value === value);
                if (normalizationOption) labelText = normalizationOption.label;

                const normalizationDisplay = document.querySelector(
                    '.flex.justify-between.items-center.p-3.bg-gray-50.rounded-lg span.font-medium.text-blue-700'
                );
                if (normalizationDisplay) normalizationDisplay.textContent = labelText;
            }
        }

        function selectOption(inputId, value, btn) {
            document.getElementById(inputId).value = value;

            // Reset all
            document.querySelectorAll("#dialogOptions .option-btn").forEach(el => {
                el.classList.remove("selected-option");
                const tick = el.querySelector(".tickmark");
                if (tick) tick.remove();
            });

            // Highlight selected + add tick
            btn.classList.add("selected-option");
            btn.insertAdjacentHTML(
                "beforeend",
                '<span class="tickmark text-purple-600 font-bold">‚úì</span>'
            );

            updateConfigurationDisplay(inputId, value);

            // Algorithm ‚Üí open modality dialog
            if (inputId === "algorithmInput") {
                if (value === "unimodal") {
                    openModalityDialog(1, 1);
                } else if (["late_fusion", "rrf", "nn"].includes(value)) {
                    openModalityDialog(2, 2);
                } else if (value === "early_fusion") {
                    // FIX: Early fusion accepts 2 OR 3 modalities
                    openModalityDialog(2, 3);
                } else {
                    document.getElementById("modalitiesInput").value = "";
                    updateModalitiesDisplay([]);
                    closeDialog();
                }
            } else {
                closeDialog();
            }
        }

        function closeDialog() {
            document.getElementById("dialogOverlay").classList.add("hidden");
            document.body.style.overflow = "";
        }

        // Close on ESC
        document.addEventListener("keydown", function (e) {
            if (e.key === "Escape") closeDialog();
        });

        function toggleSettings() {
            document.getElementById('settingsMenu').classList.toggle('hidden');
        }

        // ----- Modalities selection logic (min/max) -----
        let minModalities = 0;
        let maxModalities = 0;
        let selectedModalities = [];

        function setModalitiesSubmitState() {
            const btn = document.getElementById("dialogSubmitBtn");
            if (!btn) return;

            const algo = document.getElementById("algorithmInput").value;
            const len = selectedModalities.length;

            let ok = (len >= minModalities && len <= maxModalities);

            // Early fusion needs >=2 different modalities
            if (algo === "early_fusion") {
                ok = ok && (new Set(selectedModalities)).size >= 2;
            }

            btn.disabled = !ok;
        }

        function submitModalities() {
            const btn = document.getElementById("dialogSubmitBtn");
            if (btn && btn.disabled) return;

            document.getElementById("modalitiesInput").value = selectedModalities.join(" ");
            updateModalitiesDisplay(selectedModalities);
            closeDialog();
        }

        function openModalityDialog(min, max) {
            minModalities = min;
            maxModalities = max;
            selectedModalities = [];

            let title = "";
            if (min === 1 && max === 1) title = "Select a modality";
            else if (min === 2 && max === 2) title = "Select two modalities";
            else title = `Select ${min} or ${max} modalities`;

            document.getElementById("dialogTitle").textContent = title;

            const listHtml = dialogConfig.modalities.options.map(opt => `
            <button type="button"
                class="option-btn w-full flex justify-between items-center px-4 py-2 border rounded-lg hover:bg-purple-50"
                onclick="toggleModality('${opt.value}', this)">
                <span>${opt.label}</span>
            </button>
        `).join("");

            document.getElementById("dialogOptions").innerHTML = listHtml;

            // Show submit for modality selection
            const submitBtn = document.getElementById("dialogSubmitBtn");
            if (submitBtn) {
                submitBtn.classList.remove("hidden");
                submitBtn.disabled = true;
            }

            document.getElementById("dialogOverlay").classList.remove("hidden");
            document.getElementById("settingsMenu").classList.add("hidden");

            setModalitiesSubmitState();
        }

        function toggleModality(value, btn) {
            const algo = document.getElementById("algorithmInput").value;
            const idx = selectedModalities.indexOf(value);

            if (idx !== -1 && algo !== "nn") {
                // Deselect for non-NN (normal toggle)
                selectedModalities.splice(idx, 1);
                btn.classList.remove("selected-option");
                const tick = btn.querySelector(".tickmark");
                if (tick) tick.remove();
            }
            else if (idx !== -1 && algo === "nn") {
                // Special NN logic allowing duplicates (if you want that behavior)
                const count = selectedModalities.filter(m => m === value).length;

                if (selectedModalities.length < maxModalities) {
                    selectedModalities.push(value);
                    if (count === 0) btn.classList.add("selected-option");
                    btn.innerHTML = `<span>${value.charAt(0).toUpperCase() + value.slice(1)}</span>
                                 <span class="tickmark text-purple-600 font-bold">‚úì${selectedModalities.filter(m => m === value).length > 1 ? 'x2' : ''}</span>`;
                } else {
                    // If full, remove one instance
                    selectedModalities.splice(idx, 1);
                    const newCount = selectedModalities.filter(m => m === value).length;

                    if (newCount === 0) {
                        btn.classList.remove("selected-option");
                        btn.innerHTML = `<span>${value.charAt(0).toUpperCase() + value.slice(1)}</span>`;
                    } else {
                        btn.innerHTML = `<span>${value.charAt(0).toUpperCase() + value.slice(1)}</span>
                                     <span class="tickmark text-purple-600 font-bold">‚úì</span>`;
                    }
                }
            }
            else {
                // Select (respect maxModalities)
                if (selectedModalities.length >= maxModalities) return;

                selectedModalities.push(value);
                btn.classList.add("selected-option");
                btn.insertAdjacentHTML(
                    "beforeend",
                    '<span class="tickmark text-purple-600 font-bold">‚úì</span>'
                );
            }

            setModalitiesSubmitState();
        }

        function updateModalitiesDisplay(modalities) {
            const modalitiesDisplay = document.getElementById("modalitiesDisplay");
            if (!modalitiesDisplay) return;

            if (modalities.length === 0) {
                modalitiesDisplay.innerHTML = '<span class="text-gray-400 text-sm">None</span>';
            } else {
                // Group modalities to show x2 if needed
                const counts = {};
                modalities.forEach(m => counts[m] = (counts[m] || 0) + 1);

                const badges = Object.keys(counts).map(modality => {
                    const label = modality.charAt(0).toUpperCase() + modality.slice(1);
                    const countBadge = counts[modality] > 1 ? ` x${counts[modality]}` : '';
                    return `<span class="font-medium text-green-700 bg-green-100 px-3 py-1 rounded-full text-sm">${label}${countBadge}</span>`;
                }).join('');

                modalitiesDisplay.innerHTML = badges;
            }
        }

        // Form Validation
        document.getElementById("searchForm").addEventListener("submit", function (e) {
            const algo = document.getElementById("algorithmInput").value;
            const modalitiesStr = document.getElementById("modalitiesInput").value;
            const modalities = modalitiesStr ? modalitiesStr.split(" ") : [];

            if (algo === "unimodal") {
                if (modalities.length !== 1) {
                    alert("Unimodal algorithm requires exactly 1 modality.");
                    e.preventDefault();
                    return;
                }
            } else if (algo === "early_fusion") {
                if (modalities.length < 2 || modalities.length > 3) {
                    alert("EARLY FUSION requires 2 or 3 modalities.");
                    e.preventDefault();
                    return;
                }
                const unique = new Set(modalities);
                if (unique.size < 2) {
                    alert("EARLY FUSION requires 2 or 3 DIFFERENT modalities.");
                    e.preventDefault();
                    return;
                }
            } else if (["late_fusion", "rrf"].includes(algo)) {
                if (modalities.length !== 2) {
                    alert("Algorithm " + algo.replace("_", " ").toUpperCase() + " requires exactly 2 modalities.");
                    e.preventDefault();
                    return;
                }
                if (modalities[0] === modalities[1]) {
                    alert("Algorithm " + algo.replace("_", " ").toUpperCase() + " requires 2 DIFFERENT modalities.");
                    e.preventDefault();
                    return;
                }
            } else if (algo === "nn") {
                if (modalities.length !== 2) {
                    alert("Neural Network algorithm requires exactly 2 modalities.");
                    e.preventDefault();
                    return;
                }
            }
        });
    </script>

    <style>
        .selected-option {
            @apply bg-purple-100 border-purple-400;
        }

        /* Custom scrollbar for autocomplete dropdown */
        #autocompleteDropdown::-webkit-scrollbar {
            width: 8px;
        }

        #autocompleteDropdown::-webkit-scrollbar-track {
            background: #f3e8ff;
            border-radius: 10px;
        }

        #autocompleteDropdown::-webkit-scrollbar-thumb {
            background: #a855f7;
            border-radius: 10px;
        }

        #autocompleteDropdown::-webkit-scrollbar-thumb:hover {
            background: #9333ea;
        }
    </style>

    {% endblock %}